# Template: Common NestJS Project - Pull Request
#
# Complete PR validation workflow for NestJS projects with Docker and Helm
# Includes: NestJS CI, Docker testing, and Helm chart testing
#
# Usage:
#   1. Copy this file to your project's .github/workflows/pr.yml
#   2. Update configurations below to match your project structure
#   3. Remove docker-test or helm-test sections if not needed

name: Pull Request

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read
  security-events: write

jobs:
  nest-ci:
    name: NestJS CI
    uses: mandacode-lab/workflows/.github/workflows/nest-ci.yml@develop
    with:
      node-version: "24"
      enable-coverage: true
      coverage-threshold: 0
      enable-security-scan: true

  docker-test:
    name: Docker Test
    needs: nest-ci
    uses: mandacode-lab/workflows/.github/workflows/docker-test.yml@develop
    with:
      images: |
        [
          {"dockerfile": "app.Dockerfile"},
          {"dockerfile": "mig.Dockerfile"},
        ]
      base-path: "build"
      enable-hadolint: true
      enable-trivy: true
      trivy-severity: "HIGH,CRITICAL"

  helm-test:
    name: Helm Test
    needs: nest-ci
    uses: mandacode-lab/workflows/.github/workflows/helm-test.yml@develop
    with:
      charts: |
        [
          {"dir": "deploy/chart"}
        ]
      helm-version: "v4.0.4"
      kubernetes-version: "v1.35.0"
      enable-kubeconform: true
      enable-install-test: false
