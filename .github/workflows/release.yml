# Template: Common Go Project - Release (AWS ECR)
#
# Complete release workflow for Go projects to AWS ECR
# Includes: Docker build/push to ECR and Helm chart packaging to ECR
#
# Usage:
#   1. Copy this file to your project's .github/workflows/release.yml
#   2. Configure AWS OIDC or add AWS credentials as secrets
#   3. Update AWS region and repository configurations
#   4. Update image and chart configurations

name: Release

on:
  push:
    tags:
      - "v*"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write

jobs:
  docker-build-ecr:
    name: Build and Push Docker Images to ECR
    uses: mandacode-labs/workflows/.github/workflows/docker-build-ecr.yml@develop
    with:
      images: |
        [
          {"name": "app", "dockerfile": "app.Dockerfile"}
        ]
      base-path: "build"
      aws-region: ap-northeast-2
      ecr-registry: ${{ vars.REGISTRY }}
      ecr-repository-prefix: ${{ vars.REPOSITORY }}
      tag: ${{ github.ref_name }}
      tag-prefix: "v"
      platforms: "linux/amd64"
      create-repository: true
    secrets:
      # Option 1: OIDC (Recommended)
      aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}

      # Option 2: Access Keys (comment out if using OIDC)
      # aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      # aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  docker-build-ecr-mig:
    # only if tag is not suffixed with '-rc' or '-dev'
    if: "!contains(github.ref_name, '-rc') && !contains(github.ref_name, '-dev')"
    name: Build and Push Migration Image to ECR
    uses: mandacode-labs/workflows/.github/workflows/docker-build-ecr.yml@v0.2.1
    with:
      images: |
        [
          {"name": "migration", "dockerfile": "mig.Dockerfile"}
        ]
      base-path: "build"
      aws-region: ap-northeast-2
      ecr-registry: ${{ vars.REGISTRY }}
      ecr-repository-prefix: ${{ vars.REPOSITORY }}
      tag: ${{ github.ref_name }}
      tag-prefix: "v"
      platforms: "linux/amd64"
      create-repository: true
    secrets:
      # Option 1: OIDC (Recommended)
      aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}

      # Option 2: Access Keys (comment out if using OIDC)
      # aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      # aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
